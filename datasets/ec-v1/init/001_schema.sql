-- purpose: schema (ec-v1)
-- note: ec-v0のコア4表（app_user/product/customer_order/order_item）を維持しつつ、周辺テーブルを追加して実務感を上げる。
-- ======
-- Core tables (compatible with existing SQL)
-- ======
CREATE TABLE app_user (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email TEXT NOT NULL UNIQUE,
    display_name TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE product (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    sku TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    category TEXT NOT NULL,
    price_yen INTEGER NOT NULL CHECK (price_yen >= 0),
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE customer_order (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES app_user (id),
    order_status TEXT NOT NULL,
    ordered_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_customer_order_status CHECK (
        order_status IN (
            'draft',
            'paid',
            'cancelled',
            'shipped',
            'delivered'
        )
    )
);

CREATE TABLE order_item (
    order_id INTEGER NOT NULL REFERENCES customer_order (id) ON DELETE CASCADE,
    line_no INTEGER NOT NULL CHECK (line_no > 0),
    product_id INTEGER NOT NULL REFERENCES product (id),
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price_yen INTEGER NOT NULL CHECK (unit_price_yen >= 0),
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (order_id, line_no)
);

-- ======
-- Additional tables (for practical JOIN/aggregation/performance study)
-- ======
CREATE TABLE user_address (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES app_user (id) ON DELETE CASCADE,
    label TEXT NOT NULL, -- home/work/other
    prefecture TEXT NOT NULL,
    city TEXT NOT NULL,
    address1 TEXT NOT NULL,
    postal_code TEXT NOT NULL,
    is_default BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_user_address_label CHECK (label IN ('home', 'work', 'other')),
    CONSTRAINT chk_user_address_prefecture CHECK (
        prefecture IN (
            'Tokyo',
            'Kanagawa',
            'Chiba',
            'Saitama',
            'Osaka',
            'Aichi',
            'Fukuoka',
            'Hokkaido',
            'Hyogo',
            'Kyoto'
        )
    )
);

CREATE TABLE payment (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    order_id INTEGER NOT NULL UNIQUE REFERENCES customer_order (id) ON DELETE CASCADE,
    method TEXT NOT NULL,
    amount_yen INTEGER NOT NULL CHECK (amount_yen >= 0),
    status TEXT NOT NULL,
    paid_at TIMESTAMPTZ NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_payment_method CHECK (
        method IN (
            'card',
            'bank_transfer',
            'cash_on_delivery',
            'wallet'
        )
    ),
    CONSTRAINT chk_payment_status CHECK (status IN ('pending', 'paid', 'refunded'))
);

CREATE TABLE shipment (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    order_id INTEGER NOT NULL UNIQUE REFERENCES customer_order (id) ON DELETE CASCADE,
    carrier TEXT NOT NULL,
    tracking_no TEXT NOT NULL UNIQUE,
    status TEXT NOT NULL,
    shipped_at TIMESTAMPTZ NULL,
    delivered_at TIMESTAMPTZ NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_shipment_status CHECK (status IN ('pending', 'shipped', 'delivered'))
);

CREATE TABLE tag (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL UNIQUE
);

CREATE TABLE product_tag (
    product_id INTEGER NOT NULL REFERENCES product (id) ON DELETE CASCADE,
    tag_id INTEGER NOT NULL REFERENCES tag (id) ON DELETE CASCADE,
    PRIMARY KEY (product_id, tag_id)
);

-- ======
-- Indexes (FK columns etc.)
-- ======
CREATE INDEX idx_product_category ON product (category);

CREATE INDEX idx_customer_order_user_id ON customer_order (user_id);

CREATE INDEX idx_customer_order_status ON customer_order (order_status);

CREATE INDEX idx_customer_order_ordered_at ON customer_order (ordered_at);

CREATE INDEX idx_order_item_order_id ON order_item (order_id);

CREATE INDEX idx_order_item_product_id ON order_item (product_id);

CREATE INDEX idx_user_address_user_id ON user_address (user_id);

CREATE INDEX idx_user_address_prefecture ON user_address (prefecture);

CREATE INDEX idx_payment_method ON payment (method);

CREATE INDEX idx_payment_status ON payment (status);

CREATE INDEX idx_shipment_status ON shipment (status);

CREATE INDEX idx_product_tag_tag_id ON product_tag (tag_id);
