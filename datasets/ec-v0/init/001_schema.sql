BEGIN;

CREATE TABLE app_user (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email TEXT NOT NULL UNIQUE,
    display_name TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'inactive')),
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE product (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    sku TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    category TEXT NOT NULL,
    price_yen INTEGER NOT NULL CHECK (price_yen >= 0),
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE customer_order (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES app_user (id),
    order_status TEXT NOT NULL CHECK (
        order_status IN (
            'draft',
            'paid',
            'cancelled',
            'shipped',
            'delivered'
        )
    ),
    ordered_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    total_yen INTEGER NOT NULL CHECK (total_yen >= 0)
);

CREATE TABLE order_item (
    order_id BIGINT NOT NULL REFERENCES customer_order (id) ON DELETE CASCADE,
    line_no INTEGER NOT NULL CHECK (line_no > 0),
    product_id BIGINT NOT NULL REFERENCES product (id),
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price_yen INTEGER NOT NULL CHECK (unit_price_yen >= 0),
    PRIMARY KEY (order_id, line_no)
);

-- 後でEXPLAINで“効く/効かない”を体験できるように最低限だけ用意
CREATE INDEX idx_order_user_time ON customer_order (user_id, ordered_at DESC);

CREATE INDEX idx_item_product ON order_item (product_id);

CREATE INDEX idx_product_category ON product (category);

COMMIT;
